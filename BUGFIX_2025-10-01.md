# Bug Fixes - October 1, 2025

## Summary
Fixed two critical runtime errors that were preventing the application from functioning properly.

---

## Bug #1: React Error #31 - Rendering Object as Child

### Error Message
```
ErrorBoundary caught error: Error: Minified React error #31
Objects are not valid as a React child
```

### Root Cause
In `PinByPinEntry.jsx`, the code was attempting to render the entire object returned by `getSplitAdvice()` directly in JSX:

```jsx
<strong>Tip:</strong> {getSplitAdvice(currentSplit)}
```

The `getSplitAdvice()` function returns an object like:
```javascript
{
  targetPin: '7 pin',
  approach: 'Hit the 7-pin to deflect into the 10-pin...',
  difficulty: 'Very Hard',
  tips: ['Position far left side', '...']
}
```

React cannot render objects directly - only strings, numbers, or React elements.

### Fix
Changed the code to render only the `approach` string property:

**File:** `frontend/src/components/features/PinByPinEntry.jsx`

```jsx
// Before (ERROR - tries to render entire object)
<strong>Tip:</strong> {getSplitAdvice(currentSplit)}

// After (FIXED - renders just the text)
<strong>Tip:</strong> {getSplitAdvice(currentSplit).approach}
```

### Impact
- ✅ Split advice now displays correctly during pin-by-pin entry
- ✅ No more React rendering errors
- ✅ Application no longer crashes when a split is detected

---

## Bug #2: TypeError - activeMonths.add is not a function

### Error Message
```
Failed to process game achievements: TypeError: this.userStats.activeMonths.add is not a function
at $j.updateActivityStats
```

### Root Cause
When user stats are saved to localStorage, `activeMonths` (which is a JavaScript `Set`) gets converted to an Array via `JSON.stringify()`:

```javascript
// Saving (converts Set to Array for storage)
storableStats.activeMonths = Array.from(stats.activeMonths);
localStorage.setItem(key, JSON.stringify(storableStats));
```

However, when loading the stats back, the code was **NOT converting the Array back to a Set**:

```javascript
// Loading (BUG - returns array, not Set)
loadUserStats(userId) {
  const stored = localStorage.getItem(key);
  return stored ? JSON.parse(stored) : {};  // ❌ Array stays as Array
}
```

Later, the code tries to call `.add()` method which only exists on Sets, not Arrays:
```javascript
this.userStats.activeMonths.add(monthKey);  // ❌ CRASH - Arrays don't have .add()
```

### Fix
Modified `loadUserStats()` to convert Arrays back to Sets after loading from localStorage:

**File:** `frontend/src/utils/achievementHandler.js`

```javascript
loadUserStats(userId) {
  const key = `achievement_stats_${userId}`;
  const stored = localStorage.getItem(key);
  if (!stored) return {};
  
  const stats = JSON.parse(stored);
  
  // Convert Arrays back to Sets
  if (Array.isArray(stats.uniqueVenues)) {
    stats.uniqueVenues = new Set(stats.uniqueVenues);
  }
  if (Array.isArray(stats.activeMonths)) {
    stats.activeMonths = new Set(stats.activeMonths);
  }
  
  return stats;
}
```

### Technical Explanation
JavaScript `Set` objects:
- Are used for unique collections
- Have methods like `.add()`, `.has()`, `.size`
- Cannot be directly JSON serialized

The solution:
1. **When saving**: Convert `Set → Array` using `Array.from()`
2. **When loading**: Convert `Array → Set` using `new Set(array)`

### Impact
- ✅ Achievement processing now works correctly
- ✅ Activity tracking (active months) functions properly
- ✅ User stats persist correctly across sessions
- ✅ No more crashes when saving games

---

## Additional Issues (Network Errors)

### Error Messages
```
GET http://localhost:5000/api/games net::ERR_CONNECTION_REFUSED
GET http://localhost:5000/api/balls net::ERR_CONNECTION_REFUSED
```

### Status
**NOT A BUG** - These are expected errors when the backend server is not running or is restarting. After running `docker-compose up`, these errors should resolve automatically.

---

## Testing Verification

### Test Bug #1 (Split Advice Display)
1. Start a new pin-by-pin game entry
2. On first throw, leave a split (e.g., knock down pins 1-3 leaving 4-10)
3. Verify split advice appears with text like: "Position on the left side..."
4. Should NOT see `[object Object]` or crash

### Test Bug #2 (Achievement Stats)
1. Complete and save a game
2. Open browser console - should see NO errors about `.add()`
3. Save another game on a different day/month
4. Check achievements page - progress should update correctly
5. Refresh page - stats should persist

---

## Files Modified

1. **frontend/src/components/features/PinByPinEntry.jsx**
   - Line ~692: Changed split advice rendering from object to `.approach` property
   
2. **frontend/src/utils/achievementHandler.js**
   - Lines 153-171: Enhanced `loadUserStats()` to restore Sets from Arrays

---

## Deployment Notes

- Frontend rebuilt with `docker-compose build frontend`
- Changes are backwards compatible
- Existing localStorage data will be automatically migrated on next load
- No database changes required
- No backend changes required

---

## Lessons Learned

1. **Type Preservation**: When serializing/deserializing data structures like Sets or Maps, always handle type conversion in both directions
2. **React Rendering Rules**: Only render primitives (string/number) or React elements, never plain objects
3. **localStorage Limitations**: JSON serialization loses type information for complex objects
4. **Defensive Coding**: Always verify data types after deserialization, especially for collections

---

## Related Files for Reference

- `frontend/src/utils/splitDetection.js` - Defines `getSplitAdvice()` return structure
- `frontend/src/utils/achievementEngine.js` - Uses `activeMonths` Set operations
- `frontend/src/pages/PinCarryPage.jsx` - Correctly renders split advice object properties
